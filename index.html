<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght~400;700&display=swap'); 

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: #0d0c1d;}
        
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('img.png') no-repeat center center;
            background-size: cover;
            transition: opacity .5s ease-in;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }

        /* Loading Screen - Minimalistic Spinning Circle */
        .loading-screen{
            position:fixed;inset:0;
            background: #0d0c1d;
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            z-index:9999;transition:opacity .5s ease-out;
        }
        .loading-screen.hidden{opacity:0;pointer-events:none}
        
        .spinner-circle {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #00ffff; /* Neon color */
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); /* Neon glow */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* End of Loading Screen */

        /* Admin Button Style - New Addition (MODIFIED POSITION) */
        #adminButton {
            position: fixed; 
            top: 70px; /* Moved below the balance element (which is at top: 20px) */
            right: 20px; /* Aligned with the balance element */
            width: 100px; /* Fixed width for better appearance under the balance */
            text-align: center; /* Center the text */
            z-index: 101; /* Z-index to be above the main screen content */
            display: none; /* Hidden by default */
            padding: 8px 10px; /* Reduced padding slightly */
            background-color: #f04e6c; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 14px; /* Slightly smaller font for better fit */
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Vazirmatn', Arial, Helvetica, sans-serif;
            transition: background-color 0.2s;
        }
        #adminButton:hover {
            background-color: #e03b5b;
        }

        /* NEW Admin Panel Styles */
        .withdrawal-admin-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: right; /* RTL support */
        }
        .withdrawal-admin-list li {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Align text to the right */
        }
        .withdrawal-admin-list p {
            margin: 2px 0;
        }


        /* Main Screen */
        .main-screen{
            background-color: #f0f0f0; 
        }
        
        .main-content{flex:1;display:flex;justify-content:center;align-items:center}
        
        /* User Circle */
        .user-circle{
            position:absolute;top:20px;left:20px;width:70px;height:70px;border:2px dashed #ccc;
            border-radius:50%;display:flex;flex-direction:column;justify-content:center;
            align-items:center;cursor:pointer;transition:all .3s ease;z-index:100;overflow:hidden
        }
        .user-circle:hover{border-color:#4a90e2;background:rgba(74,144,226,.05)}
        .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
        .user-circle .placeholder{color:#999;font-size:12px;text-align:center}
        
        .user-username{
            position: absolute;
            top: 95px;
            left: 20px;
            width: 70px;
            font-size:13px;color:#555;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-id{
            position: absolute;
            top: 115px;
            left: 20px;
            width: 70px;
            font-size:11px;color:#888;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .balance{position:absolute;top:20px;right:20px;background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:16px;color:#ff2a2a;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05)}
        
        /* Shared Progress Containers */
        .progress-group-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 90%;
            max-width: 300px;
            z-index: 102;
        }
        .daily-progress-container, .spin-progress-container {
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            text-align: center;
            border-left: 5px solid #4a90e2; 
        }
        .spin-progress-container {
            border-left: 5px solid #ff8c00; 
        }
        .daily-progress-text, .spin-progress-text {font-size:14px;color:#333;margin-bottom:4px; font-weight: bold;}
        .daily-progress-bar, .spin-progress-bar {width:100%;height:12px;background:rgba(0,0,0,.1);border-radius:10px;overflow:hidden;margin-top:6px}
        .daily-progress-fill {height:100%;background:linear-gradient(90deg,#00f2fe,#4facfe);border-radius:10px;width:0%;transition:width .4s ease}
        .spin-progress-fill {height:100%;background:linear-gradient(90deg,#ff8c00, #ff4500);border-radius:10px;width:0%;transition:width .4s ease}

        /* Button Adjustments - Equal width for 5 buttons */
        .button-container{
            position:absolute;bottom:40px;left:50%;transform:translateX(-50%);
            display:grid; /* Change to grid for better control */
            grid-template-columns: repeat(5, 1fr); /* 5 equal columns (UPDATED) */
            gap: 8px; /* Slightly reduced gap */
            background:rgba(240,240,240,.9);padding:10px 10px; /* Reduced padding */
            border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px);
            width: 95%; /* Increased width for more space */
            max-width: 450px;
        }
        .nav-button{
            position:relative;background:linear-gradient(145deg,#4a90e2,#357abd);color:#fff;border:none;padding:10px 0; /* Adjust padding for height control */
            border-radius:10px;font-size:11px; /* Reduced font size for better fit */
            font-weight:bold;cursor:pointer;transition:all .1s ease;
            flex-grow: 1;
            min-width: auto;
            text-transform:uppercase;letter-spacing:.5px;box-shadow:0 5px 0 #2c5aa0,0 8px 12px rgba(0,0,0,.15);transform:translateY(0);
            text-align: center;
            line-height: 1; /* Ensure text fits */
        }
        .nav-button:hover{transform:translateY(-1px);box-shadow:0 6px 0 #2c5aa0,0 10px 15px rgba(0,0,0,.2)}
        .nav-button:active{transform:translateY(2px);box-shadow:0 3px 0 #2c5aa0,0 5px 8px rgba(0,0,0,.15)}
        .nav-button span{display:block;text-shadow:0 1px 2px rgba(0,0,0,.3)}

        .nav-button.task-btn{
            background:linear-gradient(145deg,#ffc107,#ff9800);
            box-shadow:0 5px 0 #cc9a00,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.task-btn:hover{box-shadow:0 6px 0 #cc9a00,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.task-btn:active{box-shadow:0 3px 0 #cc9a00,0 5px 8px rgba(0,0,0,.15)}

        /* NEW Style for Withdraw Nav Button */
        .nav-button.withdraw-btn-nav{
            background:linear-gradient(145deg,#ff2a2a,#cc2121);
            box-shadow:0 5px 0 #991919,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.withdraw-btn-nav:hover{box-shadow:0 6px 0 #991919,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.withdraw-btn-nav:active{box-shadow:0 3px 0 #991919,0 5px 8px rgba(0,0,0,.15)}

        /* ===== Task Screen - REVISED STYLING (High Fidelity) ===== */
        .task-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content: flex-start; /* Align content to the top */
            padding-top: 50px; /* Add padding to the top */
            padding-bottom: 120px; 
            overflow-y: auto;
            background: #f0f4f8; /* Very light, professional background */
        }
        .task-header{ 
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 320px;
        }
        .task-title{ 
             font-family: 'Vazirmatn', sans-serif; 
             font-size:28px; /* Slightly larger title */
             color:#2c3e50; /* Darker, more professional color */
             font-weight:800; /* Extra bold */
             text-shadow: 1px 1px 2px rgba(0,0,0,0.05); 
        }
        /* task-description is removed from HTML, but style kept for safety */
        .task-description{
            font-size: 16px;
            color: #555; 
            margin-top: 5px;
        }

        .task-card-container {
            width: 90%;
            max-width: 350px; /* Wider card */
            background: linear-gradient(180deg, #ffffff, #f7f9fc); /* Subtle gradient for depth */
            padding: 25px;
            border-radius: 25px; /* More rounded corners */
            box-shadow: 0 10px 30px rgba(0,0,0,.15), inset 0 0 10px rgba(255, 255, 255, 0.5); /* Enhanced shadow and inner highlight */
            border: 2px solid #e0e6ec; /* Cleaner border */
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .task-card-container::before {
            content: '‚≠ê';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 50px;
            opacity: 0.1;
            transform: rotate(15deg);
        }

        .task-item {
            padding: 0;
            border: none;
            background: transparent;
            box-shadow: none;
            margin-bottom: 25px;
            display: block; 
        }
        .task-info h4 {
            color: #3498db; /* Professional blue */
            margin-bottom: 10px;
            font-size: 22px;
            font-weight: 700;
        }
        .task-info p {
            color: #7f8c8d; /* Subdued text color */
            font-size: 15px;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .task-reward {
            font-size: 28px; /* Larger reward text */
            font-weight: 800;
            color: #e67e22; /* Vivid orange */
            font-family: 'Orbitron', sans-serif;
            padding: 12px 20px;
            background: #fff0e6;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 25px;
            border: 1px dashed #e67e22; /* Dashed border to look like a coupon */
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0,0,0,.1);
        }
        .task-action-btn {
            background:linear-gradient(145deg, #2ecc71, #27ae60); /* Success Green */
            color:#fff;border:none;padding:15px 25px; /* Increased padding */
            border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 6px 0 #219d55;transition:all .1s ease; /* Deeper shadow for 3D effect */
            text-transform: uppercase;
            width: 100%; 
            font-family: 'Vazirmatn', sans-serif;
            margin-top: 15px;
        }
        .task-action-btn:disabled {
            background: linear-gradient(145deg, #bdc3c7, #95a5a6);
            box-shadow: 0 6px 0 #7f8c8d;
            cursor: not-allowed;
            color: #ecf0f1;
        }
        .task-action-btn:active{transform:translateY(3px);box-shadow:0 3px 0 #219d55}
        
        .task-action-btn.completed {
            background:linear-gradient(145deg, #95a5a6, #7f8c8d); 
            box-shadow:0 6px 0 #6c7a89;
            color: #ecf0f1;
        }
        .task-action-btn.completed:active{transform:translateY(3px);box-shadow:0 3px 0 #6c7a89}

        /* Task Note style */
        .task-screen .note{
            margin-top: 25px;
            background: #f8f8f8;
            border-left: 5px solid #3498db;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            color: #555;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* Added Back Button Style (Reusing back-btn style from withdraw/invite screens) */
        .task-back-btn {
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #4e555b;transition:all .1s ease;
            width: 90%;
            max-width: 350px;
            margin-bottom: 20px;
        }
        .task-back-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #4e555b}
        
        /* ===== Spin Screen ===== */
        .spin-screen{
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            transition:opacity .3s ease;
        }
        #wheelBox{position:relative;margin-bottom:25px}
        #wheelCanvas{
            border-radius:50%;
            /* Enhanced 3D Look */
            box-shadow:0 0 0 10px #eee, 0 15px 35px rgba(0,0,0,0.4); 
            background-color: #fefefe; 
            border: 2px solid #ccc; 
        }
        .arrow{
            position:absolute;top:-16px;left:50%;transform:translateX(-50%);
            width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;
            border-top:28px solid #ff3366;filter:drop-shadow(0 3px 2px rgba(0,0,0,.3));z-index:10;
        }
        .spin-btn{background:#ff3366;color:#fff;border:none;padding:12px 35px;border-radius:30px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 6px 0 #cc2950;transition:all .1s ease}
        .spin-btn:active{transform:translateY(3px);box-shadow:0 3px 0 #cc2950}
        .spin-result{margin-top:18px;font-size:18px;color:#333}
        .spin-back{margin-top:25px;background:#6c757d;color:#fff;border:none;padding:10px 25px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 0 #5a6268}
        .spin-back:active{transform:translateY(2px);box-shadow:0 2px 0 #5a6268}

        /* ===== Withdraw Screen - (No changes needed) ===== */
        .withdraw-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .withdraw-header{
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .withdraw-title{
            font-size:28px;color:#ff2a2a;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .current-balance-info{
            font-size: 16px;
            color: #555;
            margin-top: 10px;
            font-weight: bold;
        }
        .input-form-container {
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,.1);
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .input-group{
            width:100%;margin-bottom:15px;
        }
        .input-group label{display:block;margin-bottom:8px;font-size:14px;color:#555;font-weight:600;}
        .input-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:10px;font-size:16px;transition:border-color .3s ease, box-shadow .3s ease;outline:none;}
        .input-group input:focus{border-color:#ff8c00;box-shadow:0 0 0 3px rgba(255,140,0,0.2);}
        .withdraw-buttons{display:flex;gap:15px;margin-top:20px;justify-content: center;}
        .withdraw-btn{
            background:linear-gradient(145deg, #28a745, #1e7e34); 
            color:#fff;border:none;padding:12px 25px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #19692c;transition:all .1s ease;
            text-transform: uppercase;
        }
        .withdraw-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #19692c}
        .back-btn{
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #4e555b;transition:all .1s ease;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        .back-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #4e555b}
        .history-table{
            width:100%;border-collapse:collapse;margin-top:15px;font-size:13px;
        }
        .history-table th,.history-table td{padding:10px;text-align:center;border-bottom:1px solid #eee;font-weight:500;}
        .history-table th{background:#f8f8f8;font-weight:700;color:#333;text-transform:uppercase;}
        .status-pending{color:#ff8c00;font-weight:bold;}
        .status-completed{color:#28a745;font-weight:bold;}
        .no-records{text-align:center;color:#999;padding:20px;}

        /* ===== Invite Screen (No changes needed) ===== */
        .invite-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .invite-header{
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .invite-title{
            font-size:28px;color:#4a90e2;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .invite-info{
            font-size: 16px;
            color: #555;
            margin-top: 10px;
            font-weight: bold;
        }
        .referral-container{
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,.1);
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .referral-link-group{
            width:100%;margin-bottom:15px;text-align: center;
        }
        .referral-link-group label{display:block;margin-bottom:8px;font-size:14px;color:#555;font-weight:600;}
        #referralLinkInput{width:100%;padding:12px 15px;border:1px dashed #4a90e2;border-radius:10px;font-size:14px;outline:none;text-align: center; color: #4a90e2; background-color: #f7faff;}
        .copy-btn{
            background:linear-gradient(145deg, #1abc9c, #16a085); 
            color:#fff;border:none;padding:12px 25px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #158b73;transition:all .1s ease;
            text-transform: uppercase;
            margin-top: 15px;
        }
        .copy-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #158b73}
        .referral-stats{
            margin-top: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 10px;
            text-align: center;
        }
        .referral-stats p{
            font-size: 14px;
            color: #555;
            margin: 5px 0;
            font-weight: 600;
        }

        /* Custom Alert - Pencil Style - SLIGHTLY SMALLER - (No changes needed) */
        .custom-alert-overlay{
            position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);
            display:flex;justify-content:center;align-items:center;z-index:10000;
            opacity:0;pointer-events:none;transition:opacity .3s ease;
        }
        .custom-alert-overlay.visible{opacity:1;pointer-events:auto}
        .custom-alert-box {
            width: 90%;
            max-width: 280px; /* Smaller max width */
            background: #ffffed; /* Off-white paper background */
            border-radius: 15px;
            padding: 20px; /* Reduced padding */
            text-align: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3), /* Base shadow */
            inset 0 0 10px rgba(0, 0, 0, 0.05); /* Inner light effect */
            border: 3px solid #6b4d32; /* Pencil/Wood border */
            transform: perspective(600px) rotateX(0deg) scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Spring effect */
        }
        .custom-alert-overlay.visible .custom-alert-box {
            transform: perspective(600px) rotateX(0deg) scale(1);
        }
        .alert-title {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 20px; /* Slightly smaller title */
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 8px; /* Reduced margin */
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
            letter-spacing: 0.5px;
        }
        .alert-message {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 13px; /* Slightly smaller message */
            color: #333;
            white-space: pre-wrap;
            line-height: 1.5;
            margin-bottom: 15px; /* Reduced margin */
        }
        .alert-icon {
            font-size: 36px; /* Slightly smaller icon */
            margin-bottom: 10px;
        }
        .alert-ok-btn {
            background: linear-gradient(145deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 8px 20px; /* Reduced padding */
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #c0631c;
            transition: all 0.1s ease;
            font-size: 14px;
        }
        .alert-ok-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #c0631c;
        }
        .alert-title.error { color: #E74C3C; }
        .alert-title.warning { color: #F39C12; }
    </style>
</head>
<body>
    
    <audio id="backgroundAudio" loop preload="auto">
        <source src="bg_music.mp3" type="audio/mpeg">
    </audio>
    <audio id="successSFX" preload="auto">
        <source src="success.mp3" type="audio/mpeg">
    </audio>
    <audio id="errorSFX" preload="auto">
        <source src="error.mp3" type="audio/mpeg">
    </audio>
    <audio id="spinSFX" preload="auto">
        <source src="spin.mp3" type="audio/mpeg">
    </audio>

    <div class="loading-screen" id="loadingScreen">
        <div class="spinner-circle"></div>
    </div>
    
    <button id="adminButton" onclick="showAdmin()">Admin</button>

    <div class="custom-alert-overlay" id="customAlert">
        <div class="custom-alert-box">
            <div class="alert-icon" id="alertIcon"></div>
            <h3 class="alert-title" id="alertTitle">Alert</h3>
            <p class="alert-message" id="alertMessage">Message here.</p>
            <button class="alert-ok-btn" onclick="hideCustomAlert()">OK</button>
        </div>
    </div>
    
    <div class="app-screen main-screen visible" id="mainScreen">
        
        <div class="user-circle" onclick="inviteFriends()">
            <img id="userPhoto" alt="User Photo" style="display:none;">
            <span class="placeholder">üë§</span>
        </div>
        <div class="user-username" id="userName">Loading...</div>
        <div class="user-id" id="userId"></div>

        <div class="balance" id="balanceContainer">
            <span id="shibBalance">0 SHIB</span>
        </div>
        
        <div class="progress-group-container">
            <div class="daily-progress-container">
                <div class="daily-progress-text">Daily Ads Watched: <span id="adsCount">0</span>/<span id="adsMax">100</span></div>
                <div class="daily-progress-bar">
                    <div class="daily-progress-fill" id="adsProgressFill"></div>
                </div>
            </div>
            <div class="spin-progress-container">
                <div class="spin-progress-text">Daily Spins Left: <span id="spinCount">0</span>/<span id="spinMax">15</span></div>
                <div class="spin-progress-bar">
                    <div class="spin-progress-fill" id="spinProgressFill"></div>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button class="nav-button task-btn" onclick="showTask()"><span>Tasks</span></button>
            <button class="nav-button" onclick="startAdSequence()"><span>Watch Ad</span></button>
            <button class="nav-button" onclick="showSpin()"><span>Spin Wheel</span></button>
            <button class="nav-button withdraw-btn-nav" onclick="showWithdraw()"><span>Withdraw</span></button>
            <button class="nav-button" onclick="inviteFriends()"><span>Invite</span></button>
        </div>
    </div>

    <div class="app-screen task-screen" id="taskScreen">
        <div class="task-card-container">
            <div class="task-header">
                <h2 class="task-title">üî• Daily Bonus & Tasks</h2>
            </div>
            <div class="task-item">
                <div class="task-info">
                    <h4>Join Telegram Channel & Claim Reward</h4>
                    <p>Complete this one-time task to instantly receive a welcome bonus to your balance.</p>
                </div>
                <div class="task-reward">+50 SHIB</div>
            </div>
            <button class="task-action-btn" id="taskActionBtn" onclick="handleTaskAction()">
                <span>Join & Claim Reward</span>
            </button>
            <div class="note">
                üí° **Note:** Click the button to join the channel. Wait 5 seconds after joining, then click the button again to **'Claim Reward'**.
            </div>
        </div>
        <button class="task-back-btn" onclick="hideTask()">Back to Main</button>
    </div>

    <div class="app-screen spin-screen" id="spinScreen">
        <div id="wheelBox">
            <div class="arrow"></div>
            <canvas id="wheelCanvas" width="280" height="280"></canvas>
        </div>
        <button class="spin-btn" id="spinBtn" onclick="startSpin()">SPIN</button>
        <div class="spin-result" id="spinResult"></div>
        <button class="spin-back" onclick="hideSpin()">Back</button>
    </div>

    <div class="app-screen withdraw-screen" id="withdrawScreen">
        <div class="withdraw-header">
            <h2 class="withdraw-title">üí∞ Request SHIB Withdrawal</h2>
            <p class="current-balance-info">Your Current Balance: <span id="withdrawBalanceDisplay">0 SHIB</span></p>
        </div>

        <div class="input-form-container">
            <div class="input-group">
                <label for="binanceIdInput">Your Binance Pay ID / Wallet Address</label>
                <input type="text" id="binanceIdInput" placeholder="Enter Binance Pay ID or SHIB Address">
            </div>
            <div class="input-group">
                <label for="withdrawAmountInput">Amount to Withdraw (Min: 10,000 SHIB)</label>
                <input type="number" id="withdrawAmountInput" placeholder="e.g., 10000">
            </div>
            <div class="withdraw-buttons">
                <button class="withdraw-btn" onclick="requestWithdrawal()">Request Withdrawal</button>
            </div>
        </div>

        <div class="input-form-container">
            <h3 style="color:#ff2a2a; margin-bottom: 15px;">Withdrawal History</h3>
            <div id="withdrawalHistoryList">
                <div class="no-records">No withdrawal records.</div>
            </div>
        </div>
        
        <button class="back-btn" onclick="hideWithdraw()">Back to Main</button>
    </div>

    <div class="app-screen invite-screen" id="inviteScreen">
        <div class="invite-header">
            <h2 class="invite-title">ü§ù Invite Friends & Earn</h2>
            <p class="invite-info">Earn 5% commission on all your friends' ad rewards!</p>
        </div>

        <div class="referral-container">
            <h3 style="color:#4a90e2; margin-bottom: 15px;">Your Referral Link</h3>
            <div class="referral-link-group">
                <input type="text" id="referralLinkInput" readonly>
            </div>
            <button class="copy-btn" onclick="copyReferralLink()">Copy Link</button>
            
            <div class="referral-stats">
                <p>Total Invited Friends: <span id="referralCountDisplay">0</span></p>
            </div>
        </div>

        <button class="back-btn" onclick="hideInvite()">Back to Main</button>
    </div>

    <div class="app-screen withdraw-screen" id="adminScreen">
        <div class="withdraw-header"> 
            <h2 class="withdraw-title" style="color:#f04e6c;">üîê ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ</h2>
            <p class="current-balance-info" style="font-size: 14px; color: #777;">ÿ•ÿØÿßÿ±ÿ© ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿ® ŸàÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</p>
        </div>

        <div class="input-form-container">
            <h3 style="color:#f04e6c; margin-bottom: 15px; text-align: right;">ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿ® ÿßŸÑŸÖÿπŸÑŸÇÿ©</h3>
            <div id="pendingWithdrawalsList" style="text-align: right;">
                <div class="no-records">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
            </div>
        </div>

        <div class="input-form-container">
            <h3 style="color:#f04e6c; margin-bottom: 15px; text-align: right;">ÿ≠ÿ∏ÿ±/ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h3>
            <div class="input-group">
                <label for="banUserIdInput" style="text-align: right;">ŸÖÿπÿ±ŸëŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ID) ŸÑŸÑÿ≠ÿ∏ÿ±/ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°</label>
                <input type="number" id="banUserIdInput" placeholder="ÿ£ÿØÿÆŸÑ Telegram User ID">
            </div>
            <div class="withdraw-buttons" style="justify-content: space-around;">
                <button class="withdraw-btn" style="background:linear-gradient(145deg, #e74c3c, #c0392b); padding: 12px 20px;" onclick="handleBanUser('ban')">ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</button>
                <button class="withdraw-btn" style="background:linear-gradient(145deg, #3498db, #2980b9); padding: 12px 20px;" onclick="handleBanUser('unban')">ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∏ÿ±</button>
            </div>
        </div>

        <button class="back-btn" onclick="hideAdmin()">ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
    </div>
    <script>
        // Global Telegram WebApp object
        const tg = window.Telegram.WebApp;
        let tgUser = tg.initDataUnsafe.user;
        let isBanned = false; // Initial state

        // UI elements
        const mainScreen = document.getElementById('mainScreen');
        const loadingScreen = document.getElementById('loadingScreen');
        const taskActionBtn = document.getElementById('taskActionBtn');
        const adsProgressFill = document.getElementById('adsProgressFill');
        const spinProgressFill = document.getElementById('spinProgressFill');
        
        // Task state
        let taskActionState = 'JOIN_OR_CLAIM'; // 'JOIN_OR_CLAIM' -> 'CLAIM' -> 'COMPLETED'
        let isProcessingTask = false;

        // Wheel elements and state
        const canvas = document.getElementById('wheelCanvas');
        const spinBtn = document.getElementById('spinBtn');
        const spinResult = document.getElementById('spinResult');
        const ctx = canvas.getContext('2d');
        const sectors = ['5', '10', '15', '20', '5']; // SHIB prizes
        const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'];
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = centerX - 10;
        let currentAngle = 0;
        let isSpinning = false;
        let spinResultActionId = null;

        // Draw the initial wheel
        drawWheel();

        // Initialize WebApp and load data
        tg.ready();
        tg.expand();
        // Set the default color scheme (can be overridden by Telegram theme later)
        tg.setHeaderColor('#4a90e2'); // Use a custom color

        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is available and update profile UI
            if (tgUser) {
                updateUserProfileUI(tgUser.photo_url, tgUser.first_name || tgUser.username, tgUser.id);
            }
            // Show the main screen after a brief loading time to ensure the app is ready and CSS is loaded
            // The actual data load happens in initDailyProgress which is called after showing the screen
            // The loading screen will be hidden after the first data load in initDailyProgress
            setTimeout(()=>{
                loadingScreen.classList.add('hidden');
                initDailyProgress();
                playBGAudio();
            }, 1500);
        });

        /* ===== Custom Alert & Audio Functions ===== */
        const backgroundAudio = document.getElementById('backgroundAudio');
        const successSFX = document.getElementById('successSFX');
        const errorSFX = document.getElementById('errorSFX');
        const spinSFX = document.getElementById('spinSFX');
        const customAlert = document.getElementById('customAlert');
        const alertBox = customAlert.querySelector('.custom-alert-box');
        const alertTitleEl = document.getElementById('alertTitle');
        const alertMessageEl = document.getElementById('alertMessage');
        const alertIconEl = document.getElementById('alertIcon');

        /**
         * Plays background music. Must be called after user interaction.
         */
        function playBGAudio() {
            // Attempt to play only if it's paused or not playing
            if (backgroundAudio.paused) {
                backgroundAudio.volume = 0.4; // Set a moderate volume
                backgroundAudio.play().catch(e => console.log("Background audio play failed, waiting for user click:", e));
            }
        }

        /**
         * Plays a sound effect (Success or Error).
         */
        function playSFX(type) {
            let sfx;
            if (type === 'success') {
                sfx = successSFX;
            } else if (type === 'error') {
                sfx = errorSFX;
            } else if (type === 'spin') {
                sfx = spinSFX;
            } else {
                return;
            }
            sfx.currentTime = 0; // Rewind to start
            sfx.volume = 0.8;
            sfx.play().catch(e => console.log("SFX play failed:", e));
        }

        /**
         * Shows a custom, stylized alert box.
         */
        function showCustomAlert(title, message, type = 'info') {
            const iconMap = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': 'üí°'
            };
            
            alertIconEl.textContent = iconMap[type] || iconMap.info;
            alertTitleEl.textContent = title;
            alertMessageEl.textContent = message;

            // Remove previous type classes
            alertTitleEl.classList.remove('error', 'warning');

            // Set new type class
            if (type === 'error') {
                alertTitleEl.classList.add('error');
            } else if (type === 'warning') {
                alertTitleEl.classList.add('warning');
            }

            customAlert.classList.add('visible');
            if (type === 'success' || type === 'error') {
                playSFX(type);
            }
        }

        /**
         * Hides the custom alert box.
         */
        function hideCustomAlert() {
            customAlert.classList.remove('visible');
        }

        /* ===== User Data and API Integration ===== */

        let shibBalance = 0;
        let adsWatchedToday = 0;
        let spinsToday = 0;
        let taskCompleted = false;
        let referralsCount = 0;
        let withdrawalHistory = [];
        const MIN_WITHDRAWAL = 10000; // Minimum withdrawal limit

        /**
         * Updates the global state variables and re-renders UI elements.
         */
        function updateState(newState) {
            shibBalance = newState.balance !== undefined ? parseFloat(newState.balance) : shibBalance;
            adsWatchedToday = newState.ads_watched_today !== undefined ? parseInt(newState.ads_watched_today) : adsWatchedToday;
            spinsToday = newState.spins_today !== undefined ? parseInt(newState.spins_today) : spinsToday;
            isBanned = newState.is_banned !== undefined ? newState.is_banned : isBanned;
            taskCompleted = newState.task_completed !== undefined ? newState.task_completed : taskCompleted;
            referralsCount = newState.referrals_count !== undefined ? parseInt(newState.referrals_count) : referralsCount;
            withdrawalHistory = newState.withdrawal_history !== undefined ? newState.withdrawal_history : withdrawalHistory;
            
            updateUI();
        }

        /**
         * Updates all dynamic UI elements based on the current state.
         */
        function updateUI() {
            document.getElementById('shibBalance').textContent = shibBalance.toLocaleString() + ' SHIB';
            document.getElementById('withdrawBalanceDisplay').textContent = shibBalance.toLocaleString() + ' SHIB';
            
            // Progress Bars
            const adsMax = DAILY_MAX; 
            const spinMax = DAILY_MAX_SPINS;
            document.getElementById('adsCount').textContent = adsWatchedToday;
            document.getElementById('adsMax').textContent = adsMax;
            document.getElementById('spinCount').textContent = spinMax - spinsToday > 0 ? spinMax - spinsToday : 0;
            document.getElementById('spinMax').textContent = spinMax;

            const adsPercent = Math.min(100, (adsWatchedToday / adsMax) * 100);
            const spinPercent = Math.min(100, ((spinMax - spinsToday) / spinMax) * 100);
            
            adsProgressFill.style.width = adsPercent + '%';
            // Spin progress is based on remaining, so max is 100% when spinsToday is 0
            spinProgressFill.style.width = spinPercent + '%'; 

            // Task Button State
            if (taskActionState === 'COMPLETED') {
                taskActionBtn.textContent = 'Task Completed ‚úÖ';
                taskActionBtn.classList.add('completed');
                taskActionBtn.disabled = true;
            } else if (taskActionState === 'CLAIM') {
                 taskActionBtn.textContent = 'Claim Reward';
                 taskActionBtn.classList.remove('completed');
                 taskActionBtn.disabled = isProcessingTask;
            } else { // JOIN_OR_CLAIM
                 taskActionBtn.textContent = 'Join & Claim Reward';
                 taskActionBtn.classList.remove('completed');
                 taskActionBtn.disabled = isProcessingTask;
            }
            
            // Referral Count
            document.getElementById('referralCountDisplay').textContent = referralsCount;
            
            // Withdrawal History
            displayWithdrawals();
            
            // Banned Check
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned for violating policies.', 'error');
                tg.MainButton.hide();
            }
            
            // Update Spin Button
            if (spinMax - spinsToday <= 0) {
                spinBtn.disabled = true;
                spinBtn.textContent = "Limit Reached";
            } else {
                spinBtn.disabled = false;
                spinBtn.textContent = "SPIN";
            }
        }

        /**
         * Updates the user profile section (Circle and Username/ID).
         */
        function updateUserProfileUI(photoUrl, userName, userId) {
            const imgEl = document.getElementById('userPhoto');
            const nameEl = document.getElementById('userName');
            const idEl = document.getElementById('userId');
            const placeHolder = document.querySelector('.placeholder');

            if(photoUrl){
                imgEl.src = photoUrl;
                imgEl.style.display = 'block';
                placeHolder.style.display = 'none';
            }
            nameEl.textContent = userName;
            idEl.textContent = 'ID: ' + userId;
        }

        /**
         * Extracts the referrer ID from Telegram's start_param.
         */
        function getRefParam() {
            let referrerId = null;
            const REF_PREFIX = 'ref_';
            if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param) {
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam.startsWith(REF_PREFIX)) {
                    referrerId = startParam.substring(REF_PREFIX.length);
                    console.log('Referrer ID from start_param:', referrerId);
                }
            }
            return referrerId;
        }

        let referrerId = getRefParam();
        const API_URL = '/api';

        // ------------------------------------------------------------------
        // **fetchApi Function**
        // ------------------------------------------------------------------
        async function fetchApi(payload) {
            if (!tgUser) {
                // English translation of the Arabic alert message
                showCustomAlert('Critical Error!', 'User data not initialized. Please restart the app. [CODE: U_NIL]', 'error');
                return { ok: false, error: 'User not initialized' };
            }
            
            const initData = Telegram.WebApp.initData;
            if (!initData) {
                // English translation of the Arabic alert message
                showCustomAlert('Critical Error!', 'initData is missing. Security check failed. [CODE: D_MIS]', 'error');
                return { ok: false, error: 'InitData missing' };
            }

            if (typeof Telegram.WebApp.showProgress === 'function') {
                Telegram.WebApp.showProgress(true);
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...payload, user_id: tgUser.id, initData })
                });

                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.ok) {
                    const errorMessage = data.error || 'Unknown server error.';
                    let alertTitle = 'Operation Failed!';
                    let alertType = 'error';
                    let cleanMessage = errorMessage;

                    // Specific error handling for user-friendly messages
                    if (errorMessage.includes('Daily ad limit')) {
                        alertTitle = 'Limit Reached!';
                        alertType = 'warning';
                        cleanMessage = 'You have reached the limit of 100 ads for the current cycle. Please try again after 6 hours.';
                    } else if (errorMessage.includes('Daily spin limit')) {
                        alertTitle = 'Limit Reached!';
                        alertType = 'warning';
                        cleanMessage = 'You have reached the limit of 15 spins for the current cycle. Please try again after 6 hours.';
                    } else if (errorMessage.includes('Rate limit exceeded')) {
                        alertTitle = 'Too Fast!';
                        alertType = 'warning';
                        cleanMessage = 'You are performing actions too quickly. Please wait a few seconds before trying again.';
                    } else if (errorMessage.includes('already completed')) {
                        alertTitle = 'Task Complete!';
                        alertType = 'info';
                        taskActionState = 'COMPLETED';
                        updateUI();
                        cleanMessage = 'You have already completed this task and received the reward.';
                    } else if (payload.type === 'completeTask' && errorMessage.includes('not joined')) {
                        alertTitle = 'Task Failed!';
                        alertType = 'error';
                        cleanMessage = 'You must join the channel first to claim the reward.';
                    } else {
                        // General error handling (English)
                        alertTitle = 'Operation Failed!';
                        alertType = 'error';
                        cleanMessage = errorMessage;
                    }

                    showCustomAlert(alertTitle, cleanMessage, alertType);
                    return { ok: false, error: errorMessage };
                }

                return data;
            } catch (error) {
                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }
                console.error(`General Fetch Error for type ${payload.type}:`, error.message);
                // English translation of the Arabic alert message
                showCustomAlert('Connection Error!', 'Could not connect to the server. Please check your internet connection.', 'error');
                return { ok: false, error: error.message };
            }
        }

        // ------------------------------------------------------------------
        // NEW: Function to request Action ID from the Server
        // ------------------------------------------------------------------
        async function requestActionId(actionType) {
            const result = await fetchApi({
                type: 'generateActionId',
                action_type: actionType
            });
            if (result.ok) {
                return result.data.action_id;
            }
            return null;
        }

        /* ===== Rewards, Limits, and Anti-Cheat (Limits here are for display only) ===== */
        const DAILY_MAX = 100;
        const DAILY_MAX_SPINS = 15;
        let shibBalance = 0; // The server will provide the real value

        /* ===== Screen Management ===== */

        async function loadUserData() {
            if (!tgUser) return;

            const result = await fetchApi({
                type: 'getUserData'
            });

            if (result.ok) {
                const taskCompleted = result.data.task_completed || false;
                
                // If banned, display alert and block access
                if (result.data.is_banned) {
                    isBanned = true;
                    showCustomAlert('Access Denied!', 'This account has been banned for violating policies. Access to the Mini App is denied.', 'error');
                    return;
                }
                
                updateState({
                    balance: result.data.balance,
                    ads_watched_today: result.data.ads_watched_today,
                    spins_today: result.data.spins_today,
                    referrals_count: result.data.referrals_count,
                    is_banned: false,
                    task_completed: taskCompleted, // Default to false
                    withdrawal_history: (result.data.withdrawal_history || []).map(item => ({
                        amount: item.amount,
                        status: item.status,
                        date: new Date(item.created_at).toLocaleDateString('en-GB')
                    }))
                });

                // Set taskActionState based on loaded data
                if (taskCompleted) {
                    taskActionState = 'COMPLETED';
                } else if (taskActionState === 'COMPLETED') { 
                    // Prevents resetting to COMPLETED if an error occurred during claim
                    taskActionState = 'JOIN_OR_CLAIM'; 
                }
                
                // üü¢ NEW: Check Admin Status
                checkAdminStatus(tgUser.id); // ‚¨ÖÔ∏è Call the function to display the button if user is admin

                mainScreen.classList.add('visible');
            }
        }

        async function initDailyProgress(){
            if (!tgUser) return;
            const registerResult = await fetchApi({
                type: 'register',
                ref_by: referrerId ? referrerId : null
            });
            if (registerResult.ok) {
                await loadUserData();
            }
        }

        /* ===== Ad Watch Functions ===== */

        /**
         * Handles the sequence of watching two ads and requesting the reward.
         */
        async function startAdSequence() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            
            if (adsWatchedToday >= DAILY_MAX) {
                // English translation of the Arabic alert message
                showCustomAlert('Limit Reached!', `Daily limit of ${DAILY_MAX} ads reached. Ôº£ÔΩèÔΩçÔΩÖ ÔΩÇÔΩÅÔΩÉÔΩã Ôº°ÔΩÜÔΩîÔΩÖÔΩí 6 Ôº®ÔΩèÔΩïÔΩíÔΩìü•©!`, 'warning');
                return;
            }

            // 1. Request Action ID from the Server
            const actionId = await requestActionId('watchAd');
            if (!actionId) return; // Error message already shown by fetchApi

            // 2. Show First Ad - NO ALERT HERE
            show_10245709()
                .then(() => {
                    // Success for Ad 1 - Immediately start the second ad - NO ALERT HERE
                    return show_10245709();
                })
                .then(async () => {
                    // Success for Ad 2 -> Proceed to reward logic
                    
                    // 3. Request ad reward from the server (Server determines reward, checks limits, and validates Action ID)
                    const adResult = await fetchApi({
                        type: 'watchAd',
                        action_id: actionId // ‚¨ÖÔ∏è Send Server-Issued ID
                    });

                    if (adResult.ok) {
                        const actualReward = adResult.data.actual_reward;
                        
                        // 4. Update UI with trusted server values
                        updateState({
                            balance: adResult.data.new_balance,
                            ads_watched_today: adResult.data.new_ads_count
                        });

                        // 5. Referral commission logic
                        if (referrerId) {
                            fetchApi({ 
                                type: 'commission', 
                                referrer_id: referrerId, 
                                source_reward: actualReward 
                            });
                        }

                        // 6. Show success message (English translation of the Arabic alert message)
                        showCustomAlert('Success!', `You earned ${actualReward} SHIB!`, 'success');

                    } 
                    // Note: Error handling is already done inside fetchApi

                })
                .catch(error => {
                    // This catches any failure in showing the ads (e.g., ad not loaded, error from ad library)
                    console.error("Ad sequence failed:", error);
                    showCustomAlert('Ad Error!', 'Failed to display the ads. Please try again.', 'error');
                });
        }


        /* ===== Task Screen Functions (Mostly unchanged) ===== */

        function showTask() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('taskScreen').classList.add('visible');
            updateUI(); // Ensure button state is up-to-date
        }
        
        // NEW function to hide the task screen (used by the new back button)
        function hideTask(){
            document.getElementById('taskScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        // Renamed and modified the old completeTask function
        async function claimTaskReward(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            if (isProcessingTask) return;
            isProcessingTask = true;
            updateUI();

            const countdownTime = 5;
            let countdown = countdownTime;

            // Start the countdown alert (in a loop)
            const timerInterval = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    showCustomAlert('Processing Reward...', `Waiting ${countdown} seconds to verify channel membership. Please do not close the app.`, 'warning');
                } else {
                    clearInterval(timerInterval);
                }
            }, 1000);

            // Wait for the delay
            await new Promise(resolve => setTimeout(resolve, countdownTime * 1000));
            
            // Clear interval just in case it wasn't cleared by the countdown check
            clearInterval(timerInterval); 

            // Show final verification message
            showCustomAlert('Verifying...', 'Contacting server to confirm membership and claim reward.', 'warning');
            
            // 1. Request Action ID from the Server
            const actionId = await requestActionId('completeTask');
            if (!actionId) {
                isProcessingTask = false;
                taskActionState = 'JOIN_OR_CLAIM'; // Reset state on error
                updateUI();
                return; // Error already shown by fetchApi
            }

            // 2. Request task reward from the server
            const taskResult = await fetchApi({
                type: 'completeTask',
                action_id: actionId // ‚¨ÖÔ∏è Send Server-Issued ID
            });
            
            isProcessingTask = false;

            if (taskResult.ok) {
                const actualReward = taskResult.data.actual_reward;
                
                // 3. Update UI with trusted server values
                updateState({
                    balance: taskResult.data.new_balance,
                    task_completed: true
                });
                taskActionState = 'COMPLETED';
                updateUI();
                
                // 4. Referral commission logic
                if (referrerId) {
                    fetchApi({ 
                        type: 'commission', 
                        referrer_id: referrerId, 
                        source_reward: actualReward 
                    });
                }
                
                // 5. Show success message (English translation of the Arabic alert message)
                showCustomAlert('Congratulations!', `Welcome bonus of ${actualReward} SHIB claimed!`, 'success');
            } else {
                taskActionState = 'JOIN_OR_CLAIM'; // If claim failed, force user to re-join/re-verify
                updateUI();
            }
        }

        /**
         * Handles the multi-stage task button action (JOIN_OR_CLAIM -> CLAIM -> COMPLETED)
         */
        function handleTaskAction() {
            if (isProcessingTask) return;
            
            if (taskActionState === 'COMPLETED') {
                return; // Do nothing if already completed
            } else if (taskActionState === 'JOIN_OR_CLAIM') {
                // First click: Change state to CLAIM and open channel link
                window.open('https://t.me/botbababab', '_blank'); // ‚¨ÖÔ∏è Open the Telegram Channel Link
                taskActionState = 'CLAIM';
                updateUI();
                // Show an instruction alert 
                showCustomAlert('Please Join Channel', 'You must join the channel first. Click the button again (after 5 seconds) to claim your reward.', 'warning');
            } else if (taskActionState === 'CLAIM') {
                // Second click: Start the 5-second delay and server verification
                claimTaskReward(); // This starts the 5-second timer and server process
            }
        }


        /* ===== Invite Screen Functions (No changes needed) ===== */

        function inviteFriends() {
            if (isBanned) {
                // English translation of the Arabic alert message
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('inviteScreen').classList.add('visible');
            generateReferralLink();
            loadUserData();
        }

        function hideInvite(){
            document.getElementById('inviteScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        function generateReferralLink() {
            const referralLinkInput = document.getElementById('referralLinkInput');
            if (!tgUser) {
                referralLinkInput.value = 'User data not available.';
                return;
            }
            const userId = tgUser.id;
            const botPath = "Bot_ad_watchbot/earn"; 
            const inviteLink = `https://t.me/${botPath}?startapp=ref_${userId}`;
            referralLinkInput.value = inviteLink;
        }

        function copyReferralLink() {
            const referralLinkInput = document.getElementById('referralLinkInput');
            referralLinkInput.select();
            referralLinkInput.setSelectionRange(0, 99999); // For mobile devices
            try {
                navigator.clipboard.writeText(referralLinkInput.value);
                // English translation of the Arabic alert message
                showCustomAlert('Copied!', 'Referral link copied to clipboard.', 'success');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showCustomAlert('Error', 'Failed to copy link. Please select and copy manually.', 'error');
            }
        }

        /* ===== Spin Wheel Functions (Mostly unchanged) ===== */
        
        function drawWheel() {
            // Setup text properties for all subsequent text drawing
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '24px Vazirmatn, sans-serif'; // Larger, stylish font for prizes
            
            const sectorCount = sectors.length;
            const arc = 2 * Math.PI / sectorCount;
            
            sectors.forEach((prize, i) => {
                const start = i * arc;
                const end = start + arc;

                // Draw sector background
                ctx.beginPath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, start, end);
                ctx.closePath();
                ctx.fill();

                // Draw sector border
                ctx.beginPath();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, start, end);
                ctx.closePath();
                ctx.stroke();

                // üê± Add Emoji to the sector
                // Calculate the position for the emoji (midpoint of the arc, halfway to the edge)
                const angle = start + arc / 2;
                const textX = centerX + radius * 0.65 * Math.cos(angle);
                const textY = centerY + radius * 0.65 * Math.sin(angle);

                // Rotate context to align the emoji with the sector
                ctx.save();
                ctx.translate(textX, textY);
                ctx.rotate(angle + Math.PI / 2); // Rotate to be perpendicular to the radius
                ctx.fillStyle = '#000'; // Color doesn't matter for emoji usually
                ctx.fillText('üê±', 0, 0);
                ctx.restore();
            });

            // Draw Center Circle
            ctx.beginPath();
            ctx.fillStyle = '#fff';
            ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
            
            // Draw Center Text
            ctx.fillStyle = '#333';
            ctx.font = '14px Vazirmatn, sans-serif';
            ctx.fillText('SPIN', centerX, centerY);
        }

        function showSpin(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('spinScreen').classList.add('visible');
            spinResult.textContent = 'Good Luck!';
            updateUI();
        }

        function hideSpin(){
            document.getElementById('spinScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
            canvas.style.transition = 'none'; // Reset transition
            canvas.style.transform = `rotate(${currentAngle}rad)`;
        }

        async function startSpin() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }

            if (isSpinning) return;
            if (DAILY_MAX_SPINS - spinsToday <= 0) {
                // English translation of the Arabic alert message
                showCustomAlert('Limit Reached!', `Daily limit of ${DAILY_MAX_SPINS} spins reached. Ôº£ÔΩèÔΩçÔΩÖ ÔΩÇÔΩÅÔΩÉÔΩã Ôº°ÔΩÜÔΩîÔΩÖÔΩí 6 Ôº®ÔΩèÔΩïÔΩíÔΩìü•©!`, 'warning');
                return;
            }
            
            isSpinning = true;
            spinBtn.disabled = true;
            spinResult.textContent = 'Spinning...';
            playSFX('spin');

            // 1. Request Action ID from the Server
            const actionId = await requestActionId('preSpin');
            if (!actionId) {
                isSpinning = false;
                spinBtn.disabled = false;
                return; // Error message already shown by fetchApi
            }
            spinResultActionId = actionId;
            
            // 2. Request the result from the server *before* the spin ends
            const preSpinRes = await fetchApi({
                type: 'preSpin', 
                action_id: spinResultActionId // ‚¨ÖÔ∏è Send Server-Issued ID
            });
            
            if (!preSpinRes.ok) {
                isSpinning = false;
                spinBtn.disabled = false;
                spinResult.textContent = 'Spin Failed!';
                return;
            }
            
            const serverPrizeIndex = preSpinRes.data.prize_index;
            
            // --- Frontend Animation Logic ---
            const sectorCount = sectors.length;
            const arc = 2 * Math.PI / sectorCount;
            
            // Calculate the angle needed to land on the center of the winning sector
            const winningAngle = serverPrizeIndex * arc + arc / 2;
            
            // Calculate rotation to make the winning angle point up (at Math.PI/2)
            let rotationToApply = Math.PI / 2 - winningAngle;
            
            // Add multiple full rotations for a dramatic spin (e.g., 5 full rotations)
            rotationToApply = rotationToApply + (5 * 2 * Math.PI);
            
            // Update the running total angle
            currentAngle += rotationToApply;

            // Apply the transformation
            canvas.style.transition = 'transform 4s cubic-bezier(0.22,0,0.2,1)';
            canvas.style.transform = `rotate(${currentAngle}rad)`;

            // Wait for the animation to finish
            setTimeout(async ()=>{
                canvas.style.transition = 'none'; // Stop transition for next time
                
                // 3. Request the final result/update from the server, confirming the outcome
                const spinResultRes = await fetchApi({
                    type: 'spinResult',
                    action_id: spinResultActionId // ‚¨ÖÔ∏è Send Action ID
                });

                isSpinning = false;
                spinBtn.disabled = false;
                
                if (spinResultRes.ok) {
                    const finalPrize = spinResultRes.data.actual_prize;
                    
                    // 4. Update balance and spin count with trusted server values
                    updateState({
                        balance: spinResultRes.data.new_balance,
                        spins_today: spinResultRes.data.new_spins_count
                    });
                    
                    spinResult.textContent = `üéâ\n\nYou won ${finalPrize} SHIB!`;
                    // English translation of the Arabic alert message
                    showCustomAlert('Congratulations!', `You won ${finalPrize} SHIB!`, 'success');
                    
                    // 5. Referral commission logic
                    if (referrerId) {
                        fetchApi({ 
                            type: 'commission', 
                            referrer_id: referrerId, 
                            source_reward: finalPrize 
                        });
                    }
                } else {
                    spinResult.textContent = 'Error. Try Again.';
                }
            }, 4000); // Match the CSS transition duration
        }

        /* ===== Withdraw Functions (No changes needed) ===== */

        function showWithdraw(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('withdrawScreen').classList.add('visible');
            displayWithdrawals(); // Render history upon opening
        }

        function hideWithdraw(){
            document.getElementById('withdrawScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        function displayWithdrawals(){
            const historyList = document.getElementById('withdrawalHistoryList');
            if (withdrawalHistory.length === 0) {
                historyList.innerHTML = '<div class="no-records">No withdrawal requests currently.</div>';
                return;
            }

            let tableHTML = '<table class="history-table">';
            // English translation of the Arabic alert message
            tableHTML += '<thead><tr><th>Date</th><th>Amount (SHIB)</th><th>Status</th></tr></thead>';
            tableHTML += '<tbody>';
            withdrawalHistory.forEach(record => {
                // English translation of the Arabic alert message
                const statusText = record.status === 'pending' ? 'Pending' : 'Completed';
                const statusClass = record.status === 'pending' ? 'status-pending' : 'status-completed';
                
                tableHTML += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.amount.toLocaleString()}</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody></table>';
            historyList.innerHTML = tableHTML;
        }

        async function requestWithdrawal() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            const binanceId = document.getElementById('binanceIdInput').value.trim();
            const amountInput = document.getElementById('withdrawAmountInput').value.trim();
            
            if (!binanceId) {
                showCustomAlert('Missing Info', 'Please enter your Binance Pay ID or SHIB wallet address.', 'error');
                return;
            }

            const amount = parseInt(amountInput);

            if (isNaN(amount) || amount < MIN_WITHDRAWAL) {
                showCustomAlert('Invalid Amount', `The minimum withdrawal amount is ${MIN_WITHDRAWAL.toLocaleString()} SHIB.`, 'error');
                return;
            }

            if (amount > shibBalance) {
                // English translation of the Arabic alert message
                showCustomAlert('Insufficient Balance', `Your balance is not enough. You have ${shibBalance.toLocaleString()} SHIB.`, 'error');
                return;
            }
            
            // 1. Request Action ID from the Server ‚¨ÖÔ∏è ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿπŸÑŸâ Withdraw
            const actionId = await requestActionId('withdraw');
            if (!actionId) return;

            // 2. Send withdrawal request via API
            const result = await fetchApi({
                type: 'withdraw',
                binanceId: binanceId,
                amount: amount,
                action_id: actionId // ‚¨ÖÔ∏è ÿ•ÿ±ÿ≥ÿßŸÑ Action ID
            });

            if (result.ok) {
                // 3. Update balance with trusted server value
                updateState({ balance: result.data.new_balance });
                
                // 4. Reload withdrawal history with new data
                await loadUserData(); 
                displayWithdrawals(); 
                
                // Clear inputs
                document.getElementById('binanceIdInput').value = '';
                document.getElementById('withdrawAmountInput').value = '';

                // English translation of the Arabic alert message
                showCustomAlert('Request Sent!', `Details:\nBinance ID: ${binanceId}\nAmount: ${amount.toLocaleString()} SHIB\n\nThe transfer will be processed within 24 hours.`, 'success');
            }
        }
        
        // ===== Admin Functions - NEW ADDITION =====

        const adminScreen = document.getElementById('adminScreen');
        const pendingWithdrawalsList = document.getElementById('pendingWithdrawalsList');
        
        // Function to check if the user is an admin and show the button
        function checkAdminStatus(userId) {
            // NOTE: The actual ADMIN_USER_ID check must be done on the server (index.js) for security.
            // The front-end check is a simple visual aid.
            // Replace 7741750541 with your actual ADMIN_USER_ID from index.js for the button to appear in the frontend.
            // For production, you may hardcode your own ID here or rely purely on the backend check.
            // As I don't know the admin ID, I'll use a placeholder.
            const ADMIN_ID_PLACEHOLDER = 12345678; 
            if (tgUser && userId === ADMIN_ID_PLACEHOLDER) { 
                document.getElementById('adminButton').style.display = 'block';
            }
        }
        
        function showAdmin(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            adminScreen.classList.add('visible');
            loadAdminData(); // Load data when showing the screen
        }

        function hideAdmin(){
            adminScreen.classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        // Function to fetch and display admin data (pending withdrawals)
        async function loadAdminData() {
            if (!tgUser) return;
            pendingWithdrawalsList.innerHTML = '<div class="no-records">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿ® ÿßŸÑŸÖÿπŸÑŸÇÿ©...</div>';

            const result = await fetchApi({
                type: 'getAdminData',
                user_id: tgUser.id
            });

            if (result.ok) {
                displayAdminData(result.data.pendingWithdrawals);
            } else {
                pendingWithdrawalsList.innerHTML = `<div class="no-records" style="color:red;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${result.error}</div>`;
            }
        }

        function displayAdminData(withdrawals) {
            if (!withdrawals || withdrawals.length === 0) {
                pendingWithdrawalsList.innerHTML = '<div class="no-records">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ≥ÿ≠ÿ® ŸÖÿπŸÑŸÇÿ© ÿ≠ÿßŸÑŸäÿßŸã.</div>';
                return;
            }

            let html = '<ul class="withdrawal-admin-list">';
            withdrawals.forEach(w => {
                const isBannedText = w.is_banned ? '<span style="color:red; font-weight:bold;"> (ŸÖÿ≠ÿ∏Ÿàÿ±)</span>' : '';
                const date = new Date(w.created_at).toLocaleDateString('en-GB') + ' ' + new Date(w.created_at).toLocaleTimeString('en-GB');

                html += `
                    <li style="border-bottom: 1px solid #eee; padding: 10px 0;">
                        <p style="font-weight: bold; color: #333; direction: rtl;">ID: ${w.id} (ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${w.user_id}${isBannedText})</p>
                        <p style="direction: rtl;">ÿßŸÑŸÖÿ®ŸÑÿ∫: ${w.amount.toLocaleString()} SHIB</p>
                        <p style="direction: rtl;">ŸáŸàŸäÿ© Binance: ${w.binance_id}</p>
                        <p style="font-size: 11px; color: #888; direction: rtl;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${date}</p>
                        <div style="margin-top: 5px; display: flex; gap: 10px; justify-content: flex-end; width: 100%;">
                            <button style="padding: 5px 10px; background-color: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;"
                                onclick="updateWithdrawalStatus(${w.id}, 'completed')">ŸÖŸàÿßŸÅŸÇÿ©</button>
                            <button style="padding: 5px 10px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;"
                                onclick="updateWithdrawalStatus(${w.id}, 'rejected')">ÿ±ŸÅÿ∂</button>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            pendingWithdrawalsList.innerHTML = html;
        }
        
        // Function to update the withdrawal status (Approve/Reject)
        async function updateWithdrawalStatus(withdrawalId, status) {
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿßŸÑÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ≥ÿ≠ÿ® ÿ±ŸÇŸÖ ${withdrawalId} ÿ•ŸÑŸâ ${status === 'completed' ? 'ŸÖŸÉÿ™ŸÖŸÑ' : 'ŸÖÿ±ŸÅŸàÿ∂'}ÿü`)) return;

            const result = await fetchApi({
                type: 'updateWithdrawalStatus',
                user_id: tgUser.id, // Admin ID
                withdrawal_id: withdrawalId,
                new_status: status
            });

            if (result.ok) {
                showCustomAlert('ŸÜÿ¨ÿßÿ≠!', `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ≥ÿ≠ÿ® ÿ±ŸÇŸÖ ${withdrawalId} ÿ•ŸÑŸâ ${status === 'completed' ? 'ŸÖŸÉÿ™ŸÖŸÑ' : 'ŸÖÿ±ŸÅŸàÿ∂'}. ${result.data.message}`, 'success');
                loadAdminData(); // Reload the list
            } else {
                showCustomAlert('ÿÆÿ∑ÿ£!', `ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ©: ${result.error}`, 'error');
            }
        }

        // Function to handle ban/unban requests
        async function handleBanUser(action) {
            const targetUserId = document.getElementById('banUserIdInput').value;
            if (!targetUserId || isNaN(targetUserId)) {
                showCustomAlert('ÿÆÿ∑ÿ£!', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖÿπÿ±ŸëŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ (ID) ÿµÿßŸÑÿ≠.', 'error');
                return;
            }

            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ${action === 'ban' ? 'ÿ≠ÿ∏ÿ±' : 'ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ±'} ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∞Ÿà ÿßŸÑŸÖÿπÿ±ŸëŸÅ ${targetUserId}ÿü`)) return;

            const result = await fetchApi({
                type: 'banUser',
                user_id: tgUser.id, // Admin ID
                target_user_id: parseInt(targetUserId),
                action: action // 'ban' or 'unban'
            });

            if (result.ok) {
                showCustomAlert('ŸÜÿ¨ÿßÿ≠!', `ÿ™ŸÖ ${action === 'ban' ? 'ÿ≠ÿ∏ÿ±' : 'ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ±'} ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∞Ÿà ÿßŸÑŸÖÿπÿ±ŸëŸÅ ${targetUserId}.`, 'success');
                document.getElementById('banUserIdInput').value = ''; // Clear input
                loadAdminData(); // Reload to update ban status in withdrawal list
            } else {
                showCustomAlert('ÿÆÿ∑ÿ£!', `ŸÅÿ¥ŸÑ ${action === 'ban' ? 'ÿ≠ÿ∏ÿ±' : 'ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ∏ÿ±'} ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${result.error}`, 'error');
            }
        }
        
        // Final event listener to ensure background audio starts on the first user interaction
        document.addEventListener('click', function handler() {
            playBGAudio();
            document.removeEventListener('click', handler); // Remove after first successful click
        });
    </script>
</body>
</html>